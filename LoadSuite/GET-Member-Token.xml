<?xml version="1.0" encoding="UTF-8"?>
<con:testCase id="759fc19a-be00-44d9-a1aa-706c23d27c2c" failOnError="false" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="GET Member Token" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" xmlns:con="http://eviware.com/soapui/config">
  <con:settings>
    <con:setting id="7026bea1-9c34-446c-8319-d9c3af471c0efileName">GET-Member-Token</con:setting>
    <con:setting id="759fc19a-be00-44d9-a1aa-706c23d27c2cfileName">GET-Member-Token</con:setting>
  </con:settings>
  <con:savedRecentRuns>1</con:savedRecentRuns>
  <con:testStep type="groovy" name="DataSource_Setup" id="3c49feb5-d24e-475f-930d-cc7e6f334165">
    <con:settings/>
    <con:config>
      <script>import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.Iterator;
import java.lang.String
import org.apache.poi.hssf.usermodel.HSSFCell;
import org.apache.poi.hssf.usermodel.HSSFRow;
import org.apache.poi.hssf.usermodel.HSSFSheet;
import org.apache.poi.hssf.usermodel.HSSFWorkbook;
import org.apache.poi.xssf.usermodel.XSSFCell;
import org.apache.poi.xssf.usermodel.XSSFRow;
import org.apache.poi.xssf.usermodel.XSSFSheet;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;


def TestStep_Count = testRunner.testCase.getTestStepCount()
def DataSource_Flag
def RunTimeDataSource_Flag
log.info TestStep_Count
def TestStep_Name
//******************Finding DataSource***************
for(i = 0;i &lt; TestStep_Count;i++){
	TestStep_Name = testRunner.testCase.getTestStepAt(i).name
	log.info TestStep_Name
	if(TestStep_Name == "DataSource"){
		log.info("Data Source present")
		DataSource_Flag = true
		break
	}else{
		DataSource_Flag = false
	}
}

for(i = 0; i &lt; TestStep_Count; i++){
	TestStep_Name = testRunner.testCase.getTestStepAt(i).name
	if(TestStep_Name == "DataSource_RunTime"){
		log.info("RunTime Data Source present")
		RunTimeDataSource_Flag = true
		break
	}
	else{
		RunTimeDataSource_Flag = false
		log.info("RunTime Data Source not present")
	}
}
log.info "Data Source: " + DataSource_Flag
log.info "Run Time Data Source: " + RunTimeDataSource_Flag


//******************Deleting Properties from DataSource****************
if(DataSource_Flag == true){
	log.info "Deleting DataSource Properties"
	def TestStep = testRunner.testCase.getTestStepByName("DataSource")
	def Property_Count = TestStep.propertyCount
	log.info Property_Count
	def Property_Name
	for(i = Property_Count - 1; i >= 0; i--)
	{
		Property_Name = TestStep.getPropertyAt(i).name
		log.info "Deleting: " + Property_Name
		TestStep.removeProperty(Property_Name)
	}
}else{
	log.info("Data Source not present")
}

//******************Deleting Properties from Run Time DataSource****************
if(RunTimeDataSource_Flag == true){
	log.info "Deleting RunTime DataSource Properties"
	def TestStep = testRunner.testCase.getTestStepByName("DataSource_RunTime")
	def Property_Count = TestStep.propertyCount
	log.info Property_Count
	def Property_Name
	for(i = Property_Count - 1; i >= 0; i--)
	{
		Property_Name = TestStep.getPropertyAt(i).name
		log.info "Deleting: " + Property_Name
		TestStep.removeProperty(Property_Name)
	}
}else{
	log.info("RunTime Data Source not present")
}

//*********Reading Excel and adding Property to DataSource*****************

if(DataSource_Flag == true){
	def Test_Data_Path = context.expand( '${Test_Data_Path}' )
	InputStream ExcelFileToRead = new FileInputStream(Test_Data_Path);
	XSSFWorkbook wb = new XSSFWorkbook(ExcelFileToRead);
	XSSFSheet sheet = wb.getSheet("Data")
	XSSFRow row; 
	XSSFCell cell;
	
	row = sheet.getRow(0)
	def Col_count = row.getLastCellNum()
	log.info Col_count

	log.info "Adding DataSource Properties"
	def TestStep = testRunner.testCase.getTestStepByName("DataSource")
	def Property_Name
	for(i = 0; i &lt; Col_count; i++){
		cell = row.getCell(i)
		def Cell_Value = String.valueOf(cell)
		log.info "Adding: " + Cell_Value
		TestStep.addProperty(Cell_Value)
	}
}


//**************Reading Excel and adding Property to RunTime DataSource***********
if(RunTimeDataSource_Flag == true){
	def Run_Time_Data = context.expand( '${Run_Time_Data}' )
	InputStream ExcelFileToRead = new FileInputStream(Run_Time_Data);
	HSSFWorkbook wb = new HSSFWorkbook(ExcelFileToRead);
	HSSFSheet sheet = wb.getSheet("Account_Run_Time_Data")
	HSSFRow row; 
	HSSFCell cell;
	
	row = sheet.getRow(0)
	def Col_count = row.getLastCellNum()
	log.info Col_count

	log.info "Adding DataSource Properties"
	def TestStep = testRunner.testCase.getTestStepByName("DataSource_RunTime")
	def Property_Name
	for(i = 0; i &lt; Col_count; i++){
		cell = row.getCell(i)
		def Cell_Value = String.valueOf(cell)
		log.info "Adding: " + Cell_Value
		TestStep.addProperty(Cell_Value)
	}
}</script>
    </con:config>
  </con:testStep>
  <con:testStep type="datasource" name="DataSource_RunTime" id="74fe9580-b198-4bc7-ab8e-4211d79e59da">
    <con:settings/>
    <con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      <con:dataSource type="Excel">
        <con:configuration>
          <file>${Run_Time_Data}</file>
          <worksheet>Account_Run_Time_Data</worksheet>
          <cell>A2</cell>
          <ignoreEmpty>true</ignoreEmpty>
          <evaluateFormulas>false</evaluateFormulas>
        </con:configuration>
      </con:dataSource>
      <con:shared>true</con:shared>
      <con:restartShared>true</con:restartShared>
      <con:property>Account_ID_Number</con:property>
      <con:property>Verification_Code</con:property>
      <con:property>Email_ID</con:property>
      <con:property>Group_ID</con:property>
      <con:completeLastOperation>true</con:completeLastOperation>
      <con:restartOnRun>true</con:restartOnRun>
    </con:config>
  </con:testStep>
  <con:testStep type="restrequest" name="GET Member Token" id="eb8b3311-3cbc-42cb-ab68-c773d43f97f2">
    <con:settings/>
    <con:config service="GET Member Token" resourcePath="/oauth/token" methodName="GET Member Token" xsi:type="con:RestRequestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      <con:restRequest name="GET Member Token" id="dbba64c0-256c-4cda-a935-104acc1c460c" mediaType="application/x-www-form-urlencoded" postQueryString="true">
        <con:settings>
          <con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting>
        </con:settings>
        <con:endpoint>${Secure_auth}</con:endpoint>
        <con:request></con:request>
        <con:originalUri>https://api.us.apiconnect.ibmcloud.com/whirlpool-developer-network-wcloud-dev/whirlpool-iot-qa/oauth/token</con:originalUri>
        <con:assertion type="Valid HTTP Status Codes" id="05adf71d-3d44-4548-8932-d57a07592325" name="Valid HTTP Status Codes">
          <con:settings/>
          <con:configuration>
            <codes>200</codes>
          </con:configuration>
        </con:assertion>
        <con:credentials>
          <con:selectedAuthProfile>No Authorization</con:selectedAuthProfile>
          <con:authType>No Authorization</con:authType>
        </con:credentials>
        <con:jmsConfig JMSDeliveryMode="PERSISTENT"/>
        <con:jmsPropertyConfig/>
        <con:parameters>
          <con:entry key="password" value="Whirlpool123"/>
          <con:entry key="grant_type" value="password"/>
          <con:entry key="client_secret" value="syntel123$"/>
          <con:entry key="client_id" value="syntel"/>
          <con:entry key="username" value="${DataSource_RunTime#Email_ID}"/>
        </con:parameters>
        <con:parameterOrder>
          <con:entry>grant_type</con:entry>
          <con:entry>username</con:entry>
          <con:entry>password</con:entry>
          <con:entry>client_id</con:entry>
          <con:entry>client_secret</con:entry>
        </con:parameterOrder>
        <con:environmentSpec>
          <con:entry environmentId="6f0100a6-91e6-476c-8a30-1216e3f39821">
            <con:authProfile>No Authorization</con:authProfile>
          </con:entry>
          <con:entry environmentId="4398ae1d-0351-4fb3-a5a2-3711b104c124">
            <con:authProfile>Inherit From Parent</con:authProfile>
          </con:entry>
          <con:entry environmentId="dc59d3b0-2cc1-4c91-a36d-62642d50ba5a">
            <con:authProfile>Inherit From Parent</con:authProfile>
          </con:entry>
          <con:entry environmentId="5c297842-d8ad-466b-8b05-f06abf54bfe2">
            <con:authProfile>Inherit From Parent</con:authProfile>
          </con:entry>
          <con:entry environmentId="276146a1-7fd3-46fe-b2f6-638c85bb127c">
            <con:authProfile>Inherit From Parent</con:authProfile>
          </con:entry>
          <con:entry environmentId="1653fcad-25f1-42dc-b777-d850bb70a926">
            <con:authProfile>Inherit From Parent</con:authProfile>
          </con:entry>
          <con:entry environmentId="355af1cd-ed93-49d8-b6be-b3da6c1def92">
            <con:authProfile>Inherit From Parent</con:authProfile>
          </con:entry>
          <con:entry environmentId="f6279578-3a49-4834-9a7b-8e92ae71f8e9">
            <con:authProfile>Inherit From Parent</con:authProfile>
          </con:entry>
        </con:environmentSpec>
      </con:restRequest>
    </con:config>
  </con:testStep>
  <con:testStep type="groovy" name="Report" id="edc361e9-cad2-4576-ad4c-eb3ac4bbc773">
    <con:settings/>
    <con:config>
      <script>def Final_Path = com.eviware.soapui.SoapUI.globalProperties.getPropertyValue("Test_Result_Path")
log.info Final_Path
def final_path = new File(Final_Path)
final_path.mkdir()


/*Get Test Case Name and Status*/

def TestCaseName = testRunner.testCase.getName()
obj = context.testCase.getTestStepByName(TestCaseName)
assertions = obj.getAssertionList()
def Status
assertions.each{
	def stat = (it.status).toString()
	if(stat == "VALID"){
		Status = "Pass"
	}
	if(stat == "FAILED"){
		Status = "Fail"
	}
}
log.info(Status)


/*Creating Txt File*/

String date = new Date()
String date_now = new Date()
date = date.replaceAll(":","_")
date = date.replaceAll(" ","_")
def TCName = TestCaseName.replaceAll(" ","_")
report_file = Final_Path + TCName + "_" + date + "_" + Status + ".txt"
/* Writing to file */
def file1 = new File(report_file)


/*Get Time Taken for request*/

obj = context.testCase.getTestStepByName(TestCaseName)
assertions = obj.getAssertionList()
def Time_Taken
assertions.each{
	Time_Taken = testRunner.testCase.testSteps[TestCaseName].testRequest.response.timeTaken
	log.info(Time_Taken)
}



/*Get Status Code*/
Header = testRunner.testCase.testSteps[TestCaseName].testRequest.response.getResponseHeaders()
Status_Code = Header["#status#"]
log.info Status_Code
file1.write("Status:  " + Status + "\n")
file1.append("Time Taken:  " + Time_Taken + " ms\n")
file1.append("TimeStamp:  " + date_now + "\n")
file1.append("Test Step:  " + TestCaseName + "\n\n\n\n")
file1.append("----------------- Http Status ------------------------------\n")
file1.append("Http Status Code:  " + Status_Code + "\n\n\n\n")
file1.append("---------------- Request ---------------------------\n")


/*Get request and response*/
myRequestStep = testRunner.testCase.getTestStepByName(TestCaseName)
def request = new String(myRequestStep.testRequest.messageExchange.rawRequestData)
def response = new String(myRequestStep.testRequest.messageExchange.rawResponseData)
file1.append(request + "\n\n\n\n")
file1.append("---------------- Response --------------------------\n")
file1.append(response)</script>
    </con:config>
  </con:testStep>
  <con:testStep type="groovy" name="Skip on failure" id="dbbe3ff3-44e7-423c-afe9-00e0ed3a4349">
    <con:settings/>
    <con:config>
      <script>def TestCaseName = testRunner.testCase.getName()
obj = context.testCase.getTestStepByName(TestCaseName)
assertions = obj.getAssertionList()
def Status
assertions.each{
	def stat = (it.status).toString()
	if(stat == "VALID"){
		Status = "Pass"
	}
	if(stat == "FAILED"){
		Status = "Fail"
	}
}
log.info(Status)

com.eviware.soapui.SoapUI.globalProperties.setPropertyValue("access_token","undefined")

if(Status == "Fail"){
testRunner.testCase.testSteps.each{k, v ->    
testRunner.cancel(k)}
}</script>
    </con:config>
  </con:testStep>
  <con:testStep type="groovy" name="Member Token - Global Variable" id="a6fb58f2-5d43-49be-9832-e16991d78675">
    <con:settings/>
    <con:config>
      <script>def token = context.expand( '${GET Member Token#Response#$[\'access_token\']}' )
def Refresh_Token = context.expand( '${GET Member Token#Response#$[\'refresh_token\']}' )

log.info(token)
com.eviware.soapui.SoapUI.globalProperties.setPropertyValue("access_token", token)

log.info "token: " + Refresh_Token
com.eviware.soapui.SoapUI.globalProperties.setPropertyValue("Refresh_Token", Refresh_Token)</script>
    </con:config>
  </con:testStep>
  <con:properties>
    <con:property>
      <con:name>Member_Token_response</con:name>
      <con:value>{"access_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJNT0hJVC5CSEFOQVdBVEBZTUFJTC5DT00iLCJzY29wZSI6WyJ0cnVzdCIsInJlYWQiLCJ3cml0ZSJdLCJvcmdhbml6YXRpb24iOiJXaGlybHBvb2wgT3JnYW5pemF0aW9uIiwiZXhwIjoxNTEwMjI1MDg5LCJhdXRob3JpdGllcyI6WyJST0xFX0FETUlOIiwiUk9MRV9XQ0xPVURfQURNSU4iXSwianRpIjoiYmM4ZjA1MjQtOWQ0Yi00YTM0LThkMDItYTQ3OTVkNmFhN2ZmIiwiY2xpZW50X2lkIjoic3ludGVsIn0.9UvcVSJ-LMDNy-2Et-TwHUblafd_jZ_tUlsDtSxLIQY","token_type":"bearer","refresh_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJNT0hJVC5CSEFOQVdBVEBZTUFJTC5DT00iLCJzY29wZSI6WyJ0cnVzdCIsInJlYWQiLCJ3cml0ZSJdLCJvcmdhbml6YXRpb24iOiJXaGlybHBvb2wgT3JnYW5pemF0aW9uIiwiZXhwIjoxNTExMjYxODg5LCJhdXRob3JpdGllcyI6WyJST0xFX0FETUlOIiwiUk9MRV9XQ0xPVURfQURNSU4iXSwianRpIjoiNzEyMTZhOGYtNmNhNy00YWY5LTlmNjktNDIzODQ1ZTJjZmIxIiwiY2xpZW50X2lkIjoic3ludGVsIn0.oqdt3OYGauc83zCZbqjLlZkqEXI1tWSv3mzu6la3nQ0","expires_in":259199,"scope":"trust read write","organization":"Whirlpool Organization","jti":"bc8f0524-9d4b-4a34-8d02-a4795d6aa7ff"}</con:value>
    </con:property>
  </con:properties>
  <con:reportParameters/>
  <con:breakPoints>
    <con:testStepId>0401e430-2634-44be-a1d9-991e7c6aca20</con:testStepId>
    <con:status>NONE</con:status>
    <con:properties/>
  </con:breakPoints>
  <con:environmentSpec>
    <con:entry environmentId="4398ae1d-0351-4fb3-a5a2-3711b104c124">
      <con:authProfile>Inherit From Parent</con:authProfile>
    </con:entry>
    <con:entry environmentId="dc59d3b0-2cc1-4c91-a36d-62642d50ba5a">
      <con:authProfile>Inherit From Parent</con:authProfile>
    </con:entry>
    <con:entry environmentId="5c297842-d8ad-466b-8b05-f06abf54bfe2">
      <con:authProfile>Inherit From Parent</con:authProfile>
    </con:entry>
    <con:entry environmentId="276146a1-7fd3-46fe-b2f6-638c85bb127c">
      <con:authProfile>Inherit From Parent</con:authProfile>
    </con:entry>
    <con:entry environmentId="1653fcad-25f1-42dc-b777-d850bb70a926">
      <con:authProfile>Inherit From Parent</con:authProfile>
    </con:entry>
    <con:entry environmentId="355af1cd-ed93-49d8-b6be-b3da6c1def92">
      <con:authProfile>Inherit From Parent</con:authProfile>
    </con:entry>
    <con:entry environmentId="f6279578-3a49-4834-9a7b-8e92ae71f8e9">
      <con:authProfile>Inherit From Parent</con:authProfile>
    </con:entry>
  </con:environmentSpec>
</con:testCase>
